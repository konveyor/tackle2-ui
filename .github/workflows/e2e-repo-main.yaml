name: e2e - run cypress tests for PRs/pushes

on:
  push:
    branches:
      - main
    paths:
      - "cypress/**"

  pull_request:
    branches:
      - main
    paths:
      - "cypress/**"
      - ".github/workflows/e2e*.yaml"
      - ".github/actions/**"

concurrency:
  group: e2e-repo-main-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # TODO: If changes are only cypress related, we don't need to build the UI image.
  build-ui-image-if-needed:
    runs-on: ubuntu-latest
    outputs:
      ui_image: ${{ steps.build-ui-image.outputs.ui_image }}
    steps:
      - uses: actions/checkout@v4

      - name: Build UI image
        id: build-ui-image
        env:
          IMG_NAME: ttl.sh/tackle2-ui-e2e-${{ github.sha }}:2h
        run: |
          echo "ui_image=${IMG_NAME}" >> "$GITHUB_OUTPUT"
          docker build . -t ${IMG_NAME}
          docker push ${IMG_NAME}

  extract-test-tags:
    runs-on: ubuntu-latest
    outputs:
      test_tags: ${{ steps.extract.outputs.test_tags }}
    steps:
      - name: Extract test tags from PR body
        id: extract
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
          DEFAULT_TAGS: "@ci,@tier0"
        run: |
          if [[ -n "$PR_BODY" ]]; then
            # Look for pattern "ci test tags: @tag1,@tag2,..." in PR body
            EXTRACTED=$(echo "$PR_BODY" | grep -oP '^ci test tags: \K@.+(,@.+)*$' || true)
            if [[ -n "$EXTRACTED" ]]; then
              echo "Found test tags in PR body: $EXTRACTED"
              echo "test_tags=$EXTRACTED" >> "$GITHUB_OUTPUT"
            else
              echo "No test tags pattern found in PR body, using default: $DEFAULT_TAGS"
              echo "test_tags=$DEFAULT_TAGS" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "No PR body available (not a pull request or body is empty), using default: $DEFAULT_TAGS"
            echo "test_tags=$DEFAULT_TAGS" >> "$GITHUB_OUTPUT"
          fi

  e2e-tests:
    needs:
      - extract-test-tags
      - build-ui-image-if-needed
    uses: ./.github/workflows/e2e-run-ui-tests.yaml
    with:
      test_tags: ${{ needs.extract-test-tags.outputs.test_tags }}
      feature_auth_required: true
      bundle_image: quay.io/konveyor/tackle2-operator-bundle:latest
      install_konveyor_version: main
      test_ref: ${{ github.event.pull_request.head.sha || github.sha }}
      ui_image: ${{ needs.build-ui-image-if-needed.outputs.ui_image }}
