name: e2e - run UI tests on minikube

on:
  workflow_call: # call from another workflow
    inputs:
      test_tags:
        type: string
        default: "@ci,@tier0"

      feature_auth_required:
        type: boolean
        default: false

      bundle_image:
        type: string
        default: quay.io/konveyor/tackle2-operator-bundle:latest

      ui_image:
        type: string
        default: quay.io/konveyor/tackle2-ui:latest

      install_konveyor_version:
        type: string
        default: main

      test_ref:
        type: string
        default: main

  workflow_dispatch: # start from GitHub UI or API
    inputs:
      test_tags:
        description: Comma separated list of test tags to run
        type: string
        default: "@ci,@tier0"

      feature_auth_required:
        description: Enable authentication?
        type: boolean
        default: false

      bundle_image:
        description: Operator bundle image to use
        type: string
        default: quay.io/konveyor/tackle2-operator-bundle:latest

      ui_image:
        description: UI image to use when installing Konveyor
        type: string
        default: quay.io/konveyor/tackle2-ui:latest

      install_konveyor_version:
        description: Ref in operator repo to use for the install-konveyor action
        type: string
        default: main

      test_ref:
        description: Ref in this repo to use for the tests
        type: string
        default: main

jobs:
  run-test:
    name: "Run tests - ${{ inputs.feature_auth_required && 'auth' || 'noauth' }}, test: ${{ inputs.test_ref }}, tags: ${{ inputs.test_tags }}"
    runs-on: ubuntu-latest

    steps:
      - name: Setup minikube
        uses: konveyor/operator/.github/actions/start-minikube@main
        with:
          memory: "max"
          cpus: "max"

      - name: Checkout the operator so we can pick the install-konveyor version to use dynamically
        uses: actions/checkout@v6
        with:
          repository: konveyor/operator
          ref: ${{ inputs.install_konveyor_version }}
          path: konveyor-operator

      - name: "Install konveyor using ${{ inputs.install_konveyor_version }}"
        uses: ./konveyor-operator/.github/actions/install-konveyor
        with:
          bundle_image: ${{ inputs.bundle_image }}
          tackle_cr: |
            kind: Tackle
            apiVersion: tackle.konveyor.io/v1alpha1
            metadata:
              name: tackle
            spec:
              image_pull_policy: IfNotPresent
              feature_auth_required: ${{ inputs.feature_auth_required }}
              ui_image_fqin: ${{ inputs.ui_image }}

      - name: Wait for Ingress
        run: |
          kubectl wait \
            -n konveyor-tackle \
            ingress/tackle \
            --timeout=600s \
            --for=jsonpath='{.status.loadBalancer.ingress[0]}'

          minikube_ip=$(minikube ip)
          echo "ingress is ready at: ${minikube_ip}"
          echo "UI_URL=https://${minikube_ip}" >>$GITHUB_ENV

      - name: Expose metrics endpoint
        run: |
          # Debug: List all pods in the namespace
          echo "Listing all pods in konveyor-tackle namespace:"
          kubectl get pods -n konveyor-tackle --show-labels

          # Find the tackle-hub pod (try different label patterns)
          echo "Finding tackle-hub pod..."
          HUB_POD=$(kubectl get pods -n konveyor-tackle -l app.kubernetes.io/name=tackle -l app.kubernetes.io/component=tackle-hub -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || true)

          if [ -z "$HUB_POD" ]; then
            echo "Trying alternative label selector..."
            HUB_POD=$(kubectl get pods -n konveyor-tackle -o jsonpath='{.items[?(@.metadata.name=="tackle-hub")].metadata.name}' 2>/dev/null || true)
          fi

          if [ -z "$HUB_POD" ]; then
            echo "Trying to find any pod with 'hub' in the name..."
            HUB_POD=$(kubectl get pods -n konveyor-tackle -o jsonpath='{.items[0].metadata.name}' --field-selector=metadata.name!=tackle-ui 2>/dev/null | grep -i hub || true)
          fi

          if [ -z "$HUB_POD" ]; then
            echo "Trying to get hub pod by name pattern..."
            HUB_POD=$(kubectl get pods -n konveyor-tackle --no-headers | grep hub | awk '{print $1}' | head -1)
          fi

          echo "Hub pod: $HUB_POD"

          if [ -z "$HUB_POD" ]; then
            echo "ERROR: Could not find tackle-hub pod"
            exit 1
          fi

          # Wait for the pod to be ready
          echo "Waiting for $HUB_POD to be ready..."
          kubectl wait --for=condition=ready pod "$HUB_POD" -n konveyor-tackle --timeout=600s

          # Port-forward metrics endpoint in the background
          kubectl port-forward -n konveyor-tackle "$HUB_POD" 2112:2112 &

          # Wait for port-forward to be ready
          sleep 5

          # Verify metrics endpoint is accessible
          echo "Testing metrics endpoint..."
          curl -s http://localhost:2112/metrics | head -10 || echo "Warning: Could not access metrics endpoint yet"

          # Set metrics URL for Cypress tests
          echo "METRICS_URL=http://localhost:2112/metrics" >>$GITHUB_ENV

      - name: "Checkout the repo (ref: ${{ inputs.test_ref }})"
        uses: actions/checkout@v6
        with:
          ref: ${{ inputs.test_ref }}
          path: tackle2-ui

      - name: "Run UI tests"
        uses: ./tackle2-ui/.github/actions/run-ui-tests
        with:
          test_tags: ${{ inputs.test_tags }}
          tests_ref: ${{ inputs.test_ref }}
          base_url: ${{ env.UI_URL }}
          metrics_url: ${{ env.METRICS_URL }}
          report_artifact_name: "ui-test-reports-${{ github.run_id }}-${{ github.job }}"
