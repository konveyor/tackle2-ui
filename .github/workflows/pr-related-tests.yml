name: PR Related Tests

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - "client/src/app/pages/**"
      - "cypress/e2e/**"
      - "package.json"
      - "package-lock.json"
      - "cypress/test-mapping.json"
      - ".github/scripts/get-related-tests.js"

concurrency:
  group: pr-related-tests-${{ github.ref }}
  cancel-in-progress: true

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      test_patterns: ${{ steps.get-tests.outputs.test_patterns }}
      should_run_tests: ${{ steps.get-tests.outputs.should_run_tests }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch base branch
        run: git fetch origin ${{ github.base_ref }}

      - name: Detect related tests
        id: get-tests
        run: |
          echo "Running related tests detector..."
          node .github/scripts/get-related-tests.js origin/${{ github.base_ref }} HEAD --expand > output.txt
          cat output.txt

          TEST_PATTERNS=$(grep "^TEST_PATTERNS=" output.txt | sed 's/^TEST_PATTERNS=//')
          echo "test_patterns=${TEST_PATTERNS}" >> $GITHUB_OUTPUT

          if [ -n "$TEST_PATTERNS" ]; then
            echo "should_run_tests=true" >> $GITHUB_OUTPUT
          else
            echo "should_run_tests=false" >> $GITHUB_OUTPUT
          fi

          echo "Tests to run: ${TEST_PATTERNS}"

      - name: Upload test patterns (debug)
        if: steps.get-tests.outputs.should_run_tests == 'true'
        run: |
          echo "${{ steps.get-tests.outputs.test_patterns }}" > test-patterns.txt
          cat test-patterns.txt

  run-related-tests:
    needs: detect-changes
    if: needs.detect-changes.outputs.should_run_tests == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        test_group: [related]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.12.2"
          cache: "npm"

      - name: Upgrade npm
        run: npm install -g npm@10.5.2

      # Install root dependencies
      - name: Install root dependencies
        run: npm ci --ignore-scripts

      # Build common workspace
      - name: Build common workspace
        run: npm run build -w common

      # Install Cypress binary
      - name: Install Cypress binary
        run: npx cypress install

      # Build UI
      - name: Build UI
        run: npm run build

      # Start backend and frontend and wait for both
      - name: Start backend & frontend
        run: |
          # Start backend server (port 8080)
          npm run start -w server &
          # Start frontend server (port 3000)
          npm run start:dev &
          # Wait for both servers to be ready
          npx wait-on http://localhost:8080 http://localhost:3000 --timeout 180000
        env:
          CI: true

      # Run Cypress tests
      - name: Run Cypress tests
        working-directory: cypress
        run: |
          TEST_PATTERNS="${{ needs.detect-changes.outputs.test_patterns }}"
          if [ -n "$TEST_PATTERNS" ]; then
            SPECS="$(echo "$TEST_PATTERNS" | tr ' ' ',')"
            echo "Running specs: $SPECS"
            npx cypress run --spec "$SPECS"
          else
            echo "No test patterns specified, skipping tests."
          fi
        env:
          CYPRESS_BASE_URL: http://localhost:3000

      # Upload test results
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-results-${{ matrix.test_group }}
          path: |
            cypress/screenshots
            cypress/videos
            cypress/results
          retention-days: 7

  test-summary:
    needs: [detect-changes, run-related-tests]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Summary
        run: |
          echo "## Test Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Should run tests:** ${{ needs.detect-changes.outputs.should_run_tests }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Test patterns detected:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ needs.detect-changes.outputs.test_patterns }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.run-related-tests.result }}" == "success" ]; then
            echo "✅ All related tests passed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.run-related-tests.result }}" == "failure" ]; then
            echo "❌ Some tests failed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.run-related-tests.result }}" == "skipped" ]; then
            echo "⏭️ No related tests to run" >> $GITHUB_STEP_SUMMARY
          fi
