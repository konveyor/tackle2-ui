@Library('migrationqe-automation-lib') _
pipeline{
    agent {
        label 'minikube-node' 
    }
    options{
        ansiColor('xterm')
    }
    environment{
        REQUESTS_CA_BUNDLE="/etc/pki/tls/certs/ca-bundle.crt"
        TACKLE_GIT_CREDS = credentials('tackle_git_pass')
        TACKLE_GIT_KEY = credentials('tackle_git_gpg_key')
        OPENAI_API_KEY=credentials('mta-openai-api-key') 
    }
    stages{
        stage("Checkout to the repository"){
            steps{
                script{
                    checkout scm
                    sh"git checkout ${params.TEST_BRANCH}"
                }
            }
        }
        stage('Install & run minikube'){   
            steps{
                script{   
                    tackle.setUiTestsEnvVars()
                    tackle.deployKonveyorOnMinikube(params.TEST_BRANCH)
                    echo "Applying tackle CR"
                    tackle.createKaiSecrets('konveyor-tackle','https://api.openai.com/v1',"$OPENAI_API_KEY")
                }
            }
        }
        stage('Run tackle ui tests'){  
            steps{
                script{
                     env.MINIKUBE_IP = sh(
                        script : 'minikube ip',
                        returnStdout: true
                    ).trim()

                    env.TACKLE_URL = "http://"+"$MINIKUBE_IP"

                    ocp.pollRouteUntilReady(env.TACKLE_URL,15,30)
                    sh "sleep 40s" //Grace period after the application is serving correctly.
                    sh(
                        script: "npm ci",
                        label: "Install dependencies..."
                    )
                    tackle.exposeMetricsRouteMinikube()
                    sh'kubectl get pods -n konveyor-tackle'
                    dir('cypress/'){
                        //Run the tests.
                        sh """ 
                        CYPRESS_INCLUDE_TAGS=@tier0,@tier1,@tier2,@tier3 npx cypress run --spec **/*.test.ts --config baseUrl=$TACKLE_URL --env user=$username,initialPassword='Passw0rd!',pass=$password,git_user=$TACKLE_GIT_CREDS_USR,git_password=$TACKLE_GIT_CREDS_PSW,git_key='$TACKLE_GIT_KEY',metricsUrl=$METRICS_URL
                        """ 
                        sh """ npm run mergereports
                               node scripts/bug_summary.mjs    
                         """
                    }   
                }
            }
        }
    }
    post{
        always{
            script{
                // Update GitHub Dashboard
                def bugSummaryPath = "cypress/run/report/bug-summary.json"
                if(fileExists(bugSummaryPath)){
                    sh """#!/bin/bash
                        set -e
                        echo "Updating GitHub dashboard..."
                        TEMP_DIR=\$(mktemp -d)
                        git clone -q --depth 1 https://${TACKLE_GIT_CREDS_USR}:${TACKLE_GIT_CREDS_PSW}@github.com/konveyor/release-tools.git "\$TEMP_DIR"
                        cd "\$TEMP_DIR"
                        TIMESTAMP=\$(date -u +"%Y-%m-%dT%H:%M:%SZ")
                        cat > community-health-dashboard/jenkins-results.json <<EOF
{
  "jobName": "UI All Tiers Nightly",
  "jobUrl": "https://jenkins-csb-migrationqe-main.dno.corp.redhat.com/view/Konveyor/job/mta/job/konveyor-ui-tiers-all-nightly",
  "lastBuild": {
    "number": ${BUILD_NUMBER},
    "status": "${currentBuild.currentResult}",
    "timestamp": "\${TIMESTAMP}",
    "duration": ${currentBuild.duration ?: 0},
    "url": "${BUILD_URL}"
  },
  "testResults": {
    "totalTests": \$(jq -r '.summary.totalTests // 0' "${WORKSPACE}/${bugSummaryPath}"),
    "passing": \$(jq -r '.summary.passing // 0' "${WORKSPACE}/${bugSummaryPath}"),
    "failing": \$(jq -r '.summary.failing // 0' "${WORKSPACE}/${bugSummaryPath}"),
    "pending": \$(jq -r '.summary.pending // 0' "${WORKSPACE}/${bugSummaryPath}"),
    "skipped": \$(jq -r '.summary.skipped // 0' "${WORKSPACE}/${bugSummaryPath}"),
    "totalBugs": \$(jq -r '.summary.totalBugs // 0' "${WORKSPACE}/${bugSummaryPath}"),
    "percentFailed": \$(jq -r '.summary.percentFailed // 0' "${WORKSPACE}/${bugSummaryPath}")
  },
  "updatedAt": "\${TIMESTAMP}"
}
EOF
                        git config user.name "Jenkins CI"
                        git config user.email "jenkins@konveyor.io"
                        git add community-health-dashboard/jenkins-results.json
                        git diff --quiet --cached || (git commit -q -m "Update Jenkins metrics #${BUILD_NUMBER}" && git push -q origin main && echo "âœ“ Dashboard updated")
                        rm -rf "\$TEMP_DIR"
                    """
                }
                cleanWs()
            }
        }
        success{
            script{
                if(params.TEST_BRANCH=="main"){
                    tackle.writeBuildStatus(passed=true,pipeline="ui-tier-all-nightly")
                }
            }
        }
        failure{
            script{
                if(params.TEST_BRANCH=="main"){
                    tackle.writeBuildStatus(passed=false,pipeline="ui-tier-all-nightly")    
                }
            }
        }  
    }
}

